<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1,  target-densitydpi=device-dpi" />

    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <title>BluefruitLE</title>
</head>
<body>
<div class="app">
    <h1>BluefruitLE</h1>
    <div id="mainPage">
        <ul id="deviceList">
        </ul>
        <button id="refreshButton">Refresh</button>
    </div>
    <div id="detailPage">
        <div id="resultDiv"></div>
        <div>
            <input type="text" id="messageInput" value="Hello"/>
            <button id="sendButton">Send</button>
        </div>
        <button id="disconnectButton">Disconnect</button>
    </div>
</div>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript">
    'use strict';

    // ASCII only
    function bytesToString(buffer) {
        return String.fromCharCode.apply(null, new Uint8Array(buffer));
    }

    // ASCII only
    function stringToBytes(string) {
        var array = new Uint8Array(string.length);
        for (var i = 0, l = string.length; i < l; i++) {
            array[i] = string.charCodeAt(i);
        }
        return array.buffer;
    }

    // this is Nordic's UART service
    var bluefruit = {
        serviceUUID: '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
        txCharacteristic: '6e400002-b5a3-f393-e0a9-e50e24dcca9e', // transmit is from the phone's perspective
        rxCharacteristic: '6e400003-b5a3-f393-e0a9-e50e24dcca9e'  // receive is from the phone's perspective
    };

    var app = {
        initialize: function() {
            this.bindEvents();
        },
        bindEvents: function() {
            document.addEventListener('deviceready', this.onDeviceReady, false);
            refreshButton.addEventListener('touchstart', this.refreshDeviceList, false);
            sendButton.addEventListener('click', this.sendData, false);
            disconnectButton.addEventListener('touchstart', this.disconnect, false);
            deviceList.addEventListener('touchstart', this.connect, false); // assume not scrolling
        },
        onDeviceReady: function() {
            app.refreshDeviceList();
        },
        refreshDeviceList: function() {
            /*ble.enable(
                    function () {
                      alert("Bluetooth ligado");

                      ble.scan(
                              [],
                              5,
                              function (device) {
                                alert(device.name + ' - ' + device.rssi + ' - ' + device.id);
                              },
                              app.onError
                      );
                    },
                    function () {
                      alert("Bluetooth nÃ£o ligado");
                    }
            );*/
            ble.scan([], 5, app.onDiscoverDevice, app.onError);
        },
        onDiscoverDevice: function(device) {
            if(device.name == 'Soft ATm') {
                alert('entrou');
                ble.connect(
                    device.id,
                    function (peripheral) {
                        alert('entrou 2');

                        var characteristic = peripheral.characteristics.filter(function (element) {
                            if (element.characteristic.toLowerCase() === bluefruit.txCharacteristic) {
                                return element;
                            }
                        })[0];

                        if (characteristic.properties.indexOf('WriteWithoutResponse') > -1) {
                            app.writeWithoutResponse = true;
                        } else {
                            app.writeWithoutResponse = false;
                        }

                        alert(app.writeWithoutResponse + ' - OK');
                    },
                    app.onError
                );
            }else
                alert(device.name);

            /*var listItem = document.createElement('li'),
                    html = '<b>' + device.name + '</b><br/>' +
                            'RSSI: ' + device.rssi + '&nbsp;|&nbsp;' +
                            device.id;

            listItem.dataset.deviceId = device.id;
            listItem.innerHTML = html;
            deviceList.appendChild(listItem);*/
        },
        connect: function(e) {
            var deviceId = e.target.dataset.deviceId,
                onConnect = function(peripheral) {
                    app.determineWriteType(peripheral);

                    // subscribe for incoming data
                    ble.startNotification(deviceId, bluefruit.serviceUUID, bluefruit.rxCharacteristic, app.onData, app.onError);
                    sendButton.dataset.deviceId = deviceId;
                    disconnectButton.dataset.deviceId = deviceId;
                    resultDiv.innerHTML = "";
                };

            ble.connect(deviceId, onConnect, app.onError);
        },
        determineWriteType: function(peripheral) {
            var characteristic = peripheral.characteristics.filter(function(element) {
                if (element.characteristic.toLowerCase() === bluefruit.txCharacteristic) {
                    return element;
                }
            })[0];

            if (characteristic.properties.indexOf('WriteWithoutResponse') > -1) {
                app.writeWithoutResponse = true;
            } else {
                app.writeWithoutResponse = false;
            }

        },
        onData: function(data) { // data received from Arduino
            console.log(data);
            resultDiv.innerHTML = resultDiv.innerHTML + "Received: " + bytesToString(data) + "<br/>";
            resultDiv.scrollTop = resultDiv.scrollHeight;
        },
        sendData: function(event) { // send data to Arduino

            var success = function() {
                console.log("success");
                resultDiv.innerHTML = resultDiv.innerHTML + "Sent: " + messageInput.value + "<br/>";
                resultDiv.scrollTop = resultDiv.scrollHeight;
            };

            var failure = function() {
                alert("Failed writing data to the bluefruit le");
            };

            var data = stringToBytes(messageInput.value);
            var deviceId = event.target.dataset.deviceId;

            if (app.writeWithoutResponse) {
                ble.writeWithoutResponse(
                    deviceId,
                    bluefruit.serviceUUID,
                    bluefruit.txCharacteristic,
                    data, success, failure
                );
            } else {
                ble.write(
                    deviceId,
                    bluefruit.serviceUUID,
                    bluefruit.txCharacteristic,
                    data, success, failure
                );
            }

        },
        disconnect: function(event) {
            var deviceId = event.target.dataset.deviceId;
            ble.disconnect(deviceId, app.showMainPage, app.onError);
        },
        showMainPage: function() {

        },
        onError: function(reason) {
            alert("ERROR: " + JSON.stringify(reason)); // real apps should use notification.alert
        }
    };
    app.initialize();
</script>
</body>
</html>