<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1,  target-densitydpi=device-dpi" />

    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <title>BluefruitLE</title>
</head>
<body>
<div class="bluetooth">
    <h1>BluefruitLE</h1>
    <button id="sendButton1">Button 1</button>
    <button id="sendButton0">Button 0</button>
    <button id="refreshButton">Update</button>
    <button id="disconnectButton">Disconnect</button>
</div>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript">
    'use strict';
    var bluetooth = {
        initialize: function () {
            this.bindEvents();
        },
        bindEvents: function () {
            document.addEventListener('deviceready', this.onDeviceReady, false);
            refreshButton.addEventListener('touchstart', this.refreshDeviceList, false);
            sendButton1.addEventListener('touchstart', this.sendData1, false);
            sendButton0.addEventListener('touchstart', this.sendData0, false);
            disconnectButton.addEventListener('touchstart', this.disconnect, false);
        },
        onDeviceReady: function () {
            bluetooth.refreshDeviceList();
        },
        refreshDeviceList: function () {
            ble.scan([], 5, bluetooth.onDiscoverDevice, bluetooth.onError);
        },
        onDiscoverDevice: function (device) {
            if (device.name == 'market4u') {
                bluetooth.deviceId = device.id;
                ble.connect(
                    bluetooth.deviceId,
                    function () {
                        ble.startNotification(
                            bluetooth.deviceId,
                            'ffe0',
                            'ffe1',
                            function (data) {

                            },
                            bluetooth.onError
                        );
                    },
                    bluetooth.onError
                );
            }
        },
        sendData0: function () {
            bluetooth.sendData('0');
        },
        sendData1: function () {
            bluetooth.sendData('1');
        },
        sendData: function (value) {
            var array = new Uint8Array(value.length);
            for (var i = 0, l = value.length; i < l; i++)
                array[i] = value.charCodeAt(i);
            ble.writeWithoutResponse(
                bluetooth.deviceId,
                'ffe0',
                'ffe1',
                array.buffer,
                function () {

                },
                function () {
                    alert("FALHA");
                }
            );
        },
        disconnect: function (event) {
            ble.disconnect(
                bluetooth.deviceId,
                function () {

                },
                bluetooth.onError
            );
        },
        onError: function (reason) {
            alert("ERROR: " + reason);
        }
    };
    bluetooth.initialize();
</script>
</body>
</html>