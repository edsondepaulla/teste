<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1,  target-densitydpi=device-dpi" />

    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <title>market4u</title>
</head>
<body>
<div class="app">
    <h1>market4u</h1>
    <div id="mainPage">
        <button id="refreshButton">Refresh</button>
    </div>
    <div id="detailPage">
        <div>
            <button id="sendButton1">Send 1</button>
            <button id="sendButton0">Send 0</button>
        </div>
        <button id="disconnectButton">Disconnect</button>
        <div id="resultDiv"></div>
    </div>
</div>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript">
    'use strict';
    var bluetooth = {
        deviceId: null,
        initialize: function() {
            this.bindEvents();
            detailPage.hidden = true;
        },
        bindEvents: function() {
            document.addEventListener('deviceready', this.onDeviceReady, false);
            refreshButton.addEventListener('touchstart', this.refreshDeviceList, false);
            sendButton1.addEventListener('click', this.sendData1, false);
            sendButton0.addEventListener('click', this.sendData0, false);
            disconnectButton.addEventListener('touchstart', this.disconnect, false);
        },
        onDeviceReady: function() {
            app.refreshDeviceList();
        },
        refreshDeviceList: function() {
            ble.scan([], 5, app.onDiscoverDevice, app.onError);
        },
        onDiscoverDevice: function(device) {
            if (device.name == 'market4u') {
                app.deviceId = device.id;
                ble.connect(
                    app.deviceId,
                    function (peripheral) {
                        var characteristic = peripheral.characteristics.filter(function (element) {
                            if (element.characteristic.toLowerCase() === bluefruit.txCharacteristic) {
                                return element;
                            }
                        })[0];
                        app.writeWithoutResponse = characteristic.properties.indexOf('WriteWithoutResponse') > -1 ? true : false;
                        ble.startNotification(
                            app.deviceId,
                            'ffe0',
                            'ffe1',
                            function (data) {

                            },
                            app.onError
                        );
                        app.showDetailPage();
                    },
                    app.onError
                );
            }
        },
        sendData0: function() {
            app.sendData('0');
        },
        sendData1: function() {
            app.sendData('1');
        },
        sendData: function(value) {
            var array = new Uint8Array(value.length);
            for (var i = 0, l = value.length; i < l; i++) {
                array[i] = value.charCodeAt(i);
            }
            if (app.writeWithoutResponse) {
                ble.writeWithoutResponse(
                    app.deviceId,
                    'ffe0',
                    'ffe1',
                    array.buffer,
                    function () {
                        console.log("success");
                    },
                    function () {
                        alert("FALHA CONECTAR MARKET4U");
                    }
                );
            }else{
                ble.write(
                    app.deviceId,
                    'ffe0',
                    'ffe1',
                    array.buffer,
                    function () {
                        console.log("success");
                    },
                    function () {
                        alert("FALHA CONECTAR MARKET4U");
                    }
                );
            }
        },
        disconnect: function(event) {
            ble.disconnect(
                app.deviceId,
                function() {
                    mainPage.hidden = false;
                    detailPage.hidden = true;
                },
                app.onError
            );
        },
        showDetailPage: function() {
            mainPage.hidden = true;
            detailPage.hidden = false;
        },
        onError: function(reason) {
            alert("ERROR: " + reason);
        }
    };
    bluetooth.initialize();
</script>
</body>
</html>