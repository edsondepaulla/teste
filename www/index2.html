<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1,  target-densitydpi=device-dpi" />

    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <title>TESTE</title>
</head>
<body>
<div class="app">
    <h1>TESTE</h1>
    <div id="mainPage">
        <ul id="deviceList">
        </ul>
        <button id="refreshButton">Refresh</button>
        <button id="startScan">startScan</button>
        <button id="stopScan">stopScan</button>
        <button id="conectar">Conectar</button>
        <button id="retrieveConnected">retrieveConnected</button>
        <button id="requestPermission">requestPermission</button>
        <button id="characteristics">characteristics</button>
        <button id="services">services</button>
        <button id="descriptors">descriptors</button>
        <button id="bond">bond</button>
    </div>
    <div id="detailPage">
        <div id="resultDiv"></div>
        <div>
            characteristic:
            <input type="text" id="input_characteristic" value="FFE1"/>

            <br>
            <br>
            service:
            <input type="text" id="input_service" value="FFE0"/>

            <br>
            <br>
            descriptor:
            <input type="text" id="input_descriptor" value=""/>

            <br>
            <br>
            Array:
            <input type="text" id="array" value="0"/>

            <br>
            <br>
            Message:
            <input type="text" id="messageInput" value="1xxxxx"/>
            <button id="sendButton">Send</button>
        </div>
        <button id="disconnectButton">Disconnect</button>
    </div>
</div>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript">
    'use strict';

    // ASCII only
    function stringToBytes(string) {
        var array = new Uint8Array(string.length);
        for (var i = 0, l = string.length; i < l; i++) {
            array[i] = string.charCodeAt(i);
        }
        return array.buffer;
    }

    var app = {
        deviceId: null,
        characteristics: null,
        initialize: function() {
            this.bindEvents();
        },
        bindEvents: function() {
            document.addEventListener('deviceready', this.onDeviceReady, false);
            refreshButton.addEventListener('touchstart', this.refreshDeviceList, false);
            sendButton.addEventListener('click', this.sendData, false);
            conectar.addEventListener('click', this.conectar, false);
            startScan.addEventListener('click', this.startScan, false);
            startScan.addEventListener('click', this.startScan, false);
            stopScan.addEventListener('click', this.stopScan, false);
            retrieveConnected.addEventListener('click', this.retrieveConnected, false);
            requestPermission.addEventListener('click', this.requestPermission, false);
            characteristics.addEventListener('click', this.characteristicsF, false);
            services.addEventListener('click', this.services, false);
            descriptors.addEventListener('click', this.descriptors, false);
            bond.addEventListener('click', this.bond, false);
            disconnectButton.addEventListener('touchstart', this.disconnect, false);
        },
        onDeviceReady: function() {
            resultDiv.innerHTML = resultDiv.innerHTML + "<br><br>" + JSON.stringify(device);
            app.refreshDeviceList();
        },
        device: null,
        refreshDeviceList: function() {
            bluetoothle.initialize(
                function (result) {
                    resultDiv.innerHTML = resultDiv.innerHTML + "<br><br>" + JSON.stringify(result);
                },
                {
                    "request": true
                }
            );
        },
        stopScan : function() {
            bluetoothle.stopScan (
                function (result) {
                    resultDiv.innerHTML = resultDiv.innerHTML + "<br><br>" + JSON.stringify(result);
                },
                function (result) {
                    alert(JSON.stringify(result));
                }
            );
        },
        startScan: function() {
            bluetoothle.startScan(
                function (result) {
                    resultDiv.innerHTML = resultDiv.innerHTML + "<br><br>" + JSON.stringify(result);
                },
                function (result) {
                    alert(JSON.stringify(result));
                },
                {
                    "services": null,
                    "allowDuplicates": false,
                    "scanMode": bluetoothle.SCAN_MODE_LOW_POWER,
                    "matchMode": bluetoothle.MATCH_MODE_STICKY,
                    "matchNum": bluetoothle.MATCH_NUM_ONE_ADVERTISEMENT,
                    "callbackType": bluetoothle.CALLBACK_TYPE_FIRST_MATCH,
                }
            );
        },
        onDiscoverDevice: function(device) {
            if(device.name == 'Soft ATm') {
                alert('entrou');
                app.deviceId = device.id;
                ble.connect(
                    app.deviceId,
                    function (peripheral) {
                        resultDiv.innerHTML = JSON.stringify(device)+"<br><br>"+JSON.stringify(peripheral)+"<br><br>";

                        alert('entrou 2');
                        var x = 0;
                        var xxx = peripheral.characteristics.filter(function (element) {
                            resultDiv.innerHTML = resultDiv.innerHTML + "<br>"+x+" - " + JSON.stringify(element);
                            resultDiv.scrollTop = resultDiv.scrollHeight;
                            x++;
                        })[0];

                        app.characteristics = peripheral.characteristics;
                    },
                    app.onError
                );
            }
        },
        requestPermission: function(){
            bluetoothle.requestPermission(
                function (result) {
                    resultDiv.innerHTML = resultDiv.innerHTML + "<br><br>" + JSON.stringify(result);
                },
                function (result) {
                    alert(JSON.stringify(result));
                }
            );
            bluetoothle.requestLocation(
                function (result) {
                    resultDiv.innerHTML = resultDiv.innerHTML + "<br><br>" + JSON.stringify(result);
                },
                function (result) {
                    alert(JSON.stringify(result));
                }
            );
        },
        retrieveConnected: function(){
            bluetoothle.retrieveConnected(
                function (result) {
                    resultDiv.innerHTML = resultDiv.innerHTML + "<br><br>" + JSON.stringify(result);
                },
                function (result) {
                    alert(JSON.stringify(result));
                },
                {
                    "services": []
                }
            );
        },
        descriptors: function(){
            bluetoothle.descriptors(
                function (result) {
                    resultDiv.innerHTML = resultDiv.innerHTML + "<br><br>" + JSON.stringify(result);
                },
                function (result) {
                    alert(JSON.stringify(result));
                },
                {
                    "address": "20EBB795-A0E4-A0E3-5E7C-2BF59DFD9B78",
                    "characteristic": input_characteristic.value,
                    "service": input_service.value,
                }
            );
        },
        services: function(){
            bluetoothle.services(
                function (result) {
                    resultDiv.innerHTML = resultDiv.innerHTML + "<br><br>" + JSON.stringify(result);
                },
                function (result) {
                    alert(JSON.stringify(result));
                },
                {
                    "address": "20EBB795-A0E4-A0E3-5E7C-2BF59DFD9B78"
                }
            );
        },
        characteristicsF: function(){
            bluetoothle.characteristics(
                function (result) {
                    resultDiv.innerHTML = resultDiv.innerHTML + "<br><br>" + JSON.stringify(result);
                },
                function (result) {
                    alert(JSON.stringify(result));
                },
                {
                    "address": "20EBB795-A0E4-A0E3-5E7C-2BF59DFD9B78",
                    "service": input_service.value
                }
            );
        },
        bond: function(){
            bluetoothle.bond(
                function (result) {
                    resultDiv.innerHTML = resultDiv.innerHTML + "<br><br>" + JSON.stringify(result);
                },
                function (result) {
                    alert(JSON.stringify(result));
                }
            );
        },
        conectar: function() {
            bluetoothle.connect(
                function (result) {
                    resultDiv.innerHTML = resultDiv.innerHTML + "<br><br>" + JSON.stringify(result);
                },
                function (result) {
                    alert(JSON.stringify(result));
                },
                {
                    "address": "20EBB795-A0E4-A0E3-5E7C-2BF59DFD9B78"
                }
            );
        },
        sendData: function() { // send data to Arduino
            alert('Enviando msg: ' + messageInput.value);

            var service = evothings.ble.getService(app.device, SERVICE_UUID)
            var characteristic = evothings.ble.getCharacteristic(service, CHARACTERISTIC_UUID)

            evothings.ble.writeCharacteristic(
                app.device,
                characteristic,
                stringToBytes(messageInput.value), // Buffer view with data to write
                function () {
                    alert('characteristic written');
                },
                function (errorCode) {
                    alert('writeCharacteristic error: ' + errorCode);
                }
            );

            return;

            var success = function (e) {
                alert("Ok - "+e);
                resultDiv.innerHTML = resultDiv.innerHTML + "Sent: " + messageInput.value + "<br/>";
                resultDiv.scrollTop = resultDiv.scrollHeight;
            };

            var failure = function (e) {
                alert("Failed writing data to the - " + e);
            };

            var data = stringToBytes(messageInput.value);

            var characteristic_get = app.characteristics[parseInt(array.value)];

            var service = characteristic_get.service;
            var characteristic = characteristic_get.characteristic;

            ble.writeWithoutResponse(
                app.deviceId,
                service,
                characteristic,
                data, success, failure
            );
        },
        disconnect: function(event) {
            app.deviceId = null;

            return;

            ble.disconnect(app.deviceId, app.showMainPage, app.onError);
        },
        showMainPage: function() {
            resultDiv.innerHTML - '';
        },
        onError: function(reason) {
            alert("ERROR: " + JSON.stringify(reason)); // real apps should use notification.alert
        }
    };
    app.initialize();
</script>
</body>
</html>